# Introduction

The scripts in this directory can be used to automate the SharePoint content migration process.  The scripts provide the following functionality:

- Bulk operations driven by csv-formatted files
- Automated creation of target Office 365 site collections
- Initial and Incremental Site Collection Migrations using Sharegate Desktop
- Post-migration Site Collection processing
- Filtering and Aggregating of Migration warnings and errors
- Site collection auditing - generation of a "suspicious links" report
- Creation of multiple, alternate versions of site collection migrations via the "tag" parameter


# Functions

The file call sequence along with functional details are described below.

## Migrations

- RunMigrate.ps1 -> MainMigrate.ps1

Both initial and incremental migrations are supported.  These functions serve as a "wrapper" for Sharegate Desktop Powershell functions.


Initial migration includes deletion and (re)creation of  target site collections as well as the Sharegate site collection migration.  In order to avoid triggers of Alerts during content migration, Alerts are disabled prior to content migration and re-enabled after each migration. After the migration, all logos in the site/sub-sites will be updated to a standard logo.  In addition, all lists/libraries will be set to use the "classic experience".

Initial Migration examples:

    MigrateMain -migrationSites "$ScriptDirectory\MigrationGroups\MigrationG9.csv"

This request will perform the initial migration of the site collections specified in the csv file. Initial migration will occur in two phases - structural migration followed by a content migration before which all User Alerts are disabled and after which User Alerts are re-enabled.  Separation of structural and content migration enables supression of User Alerts associated with Content Migration.
 

    MigrateMain -migrationSites "$ScriptDirectory\MigrationGroups\MigrationITDept.csv" -tag "-dev"

This request will perform the initial migration of the site collections specified in the csv file.  Because the -tag argument is specified, all destination sites will be created using the tag as a suffix resulting in site name as shown below:

    /sites/acme -> /sites/acme-dev


Incremental Migration examples:

    RefreshMain -migrationSites "$ScriptDirectory\MigrationGroups\MigrationG9.csv"

This request will perform an incremental migration of existing site collections.  After the migrations, all logos in the site/sub-sites will be updated to standard logo.  In addition, all lists/libraries will be set to use the "classic experience".

    RefreshMain -migrationSites "$ScriptDirectory\MigrationGroups\MigrationITDept.csv" -tag "-dev"

In this case, the -tag is added to correctly process site collections that were initially created with a -tag.

## Site Collection Migration Reporting

- RunMigrationReport.ps1 -> MigrationReport.ps1


This function processes migration export files that are generated by the Initial and Incremental migration processes. 

The Sharegate migration exports contain many errors and warnings that are not relevant within the current environment.  The 
"Get-MigrationReport" function contains filters to remove such extraneous messages and results in a smaller, more useful report.

Since these exports are generated on multiple servers, the best practice is to copy all the migration export files for a migration group to a single file directory before running the function.


Example:

    MigrationReportAll -scanDirectory "C:\Advantage\MigrationData\Group9\"

This request will generate a csv summary report of all migration warnings and errors from all the migration export files found in the scan directory. 



## Site Collection Audit

- RunAudit.ps1 -> MainAudit.ps1

This function will generate an output file containing "suspicious" links found on the target sites. Suspicious links are those that may need to be potentially changed (e.g. not correctly converted by the migration process) and will include the following links:
    - specified with a full URL
    - containing Query String parameters that could be incorrect in the new environment
    - not a direct descendant of site on which they are found


Example:

    AuditMain -migrationSites "$ScriptDirectory\MigrationGroups\MigrationG9.csv" -outputPath "C:\Advantage\MigrationData\Group9\links"



## Convert Legacy to Modern Pages

- RunConvertToModern.ps1 -> MainConvertToModern.ps1
  
Example:

    ConvertToModernMain -migrationSites "$ScriptDirectory\MigrationGroups\MigrationITDept.csv"


# Files
    
The migration scripts are designed to be used on multiple servers without modification.  (NOTE: Powershell Remoting was not possible with the Sharegate Powershell utilities).  The Get-SiteCollectionList function (found in globals.ps1) contains logic to only include site collections marked for processing on the current server.  Changes to the scripts must be made centrally. After updating the scripts can be copied to each server into a standard directory.

## File Details

- \MigrationGroups\Migration*.csv - each of these files specifies a site collection group.  These files are used as input to allow bulk site migration. Each of these files contain the following columns:
  - Site - specifies path of source site collection
  - Group - number corresponds to server number; each server will only process the sites with a number matching server number
  - UpdateLogo - ignore, no effect

- globals.ps1 - contain environment-specific global variables as well as the "Get-SiteCollectionList" function which processes the csv content and creates server-specific site collection lists. (NOTE: Source sites located at "/clients"  are mapped to "/sites/client-" in this function.)

- Run*.ps1 - specify a command to be run along with the appropriate .csv and/or directory path input

- Main*.ps1 - main, driver programs for main functions

- *.ps1 - files not including the "Run" or "Main" prefix/suffix contain the core migration functionality
